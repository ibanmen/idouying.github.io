---
title: 阿里云专有网络 VPC 自建 NAT 网关
date: 2019-10-06 15:20:00
categories: Linux
tags:
  - linux
  - nat
---


`NAT`（Network Address Translation，网络地址转换），分为 `DNAT`（Destination）和 `SNAT`（Source）。

`DNAT`，使用 `PREROUTING`，用于外网访问内网里的主机服务器，透明转发或端口映射。

`SNAT`，使用 `POSTROUTING` ，用于内网里的主机，访问外网，即分享公网IP。

<!--more-->

## SLB、EIP、NAT网关之间区别

阿里云的公网入口产品共有三个，SLB、EIP、NAT网关，这几个产品都可以作为云上资源的公网入口，他们之间有何区别，又分别应该在什么场景下使用呢？

### 负载均衡SLB

对多台云服务器进行流量分发的负载均衡服务，可以通过流量分发扩展应用系统对外的服务能力，通过消除单点故障提升应用系统的可用性。

可见云计算中的负载均衡除了通过流量分发让后端的服务器负载均衡，还有两个重要的用途，一就是消除单点故障，因为一般负载均衡后端挂载有多台ecs服务器，当某一台不工作时，系统的可用性不会受到影响；二是通过多台后端服务器一起工作，以扩展应用系统的整体处理能力。

拿刚刚过去的双十一举例，大家都知道，2017年双11又创造了新纪录，全天交易额1682亿，交易峰值32.5万笔/秒，支付峰值25.6W笔/秒，如此海量的访问请求，是再强大的服务器也无法支撑的，因此需要n多台服务器一起来提供服务，而这些服务器的调度都需要依赖负载均衡SLB，负载均衡SLB接收到用户的请求，智能调度到后端的服务器进行处理，并将处理后的结果返回给用户，完成了单台服务器不可能完成的任务。

> 注意：负载均衡SLB仅提供被动访问公网的能力，即后端ECS只能在收到通过负载均衡SLB转发来的公网的请求时，才能访问公网回应该请求，不具备SNAT功能。

### 弹性公网IP（EIP）

独立的公网IP资源，可以绑定到阿里云专有网络VPC类型的ECS、NAT网关、私网负载均衡SLB上，并可以动态解绑，实现公网IP和ECS、NAT网关、SLB的解耦，满足灵活管理的要求。

早期的弹性公网IP，只能绑定ECS，其主要目的是为了解耦服务器IP与服务器实体之间的强关联，设想这样的情况。在业务发展初期，访问量较小，用户购买一个较小规格的ECS实例即可满足业务需求，但随着用户量和业务量逐渐攀升，不可避免的需要更换更大规格的ECS，或者使用SLB+ECS便于后续的扩展，如果没有弹性公网EIP，更换ECS意味更换实例IP，这样一来，不可避免的会出现业务的中断，而EIP的出现就很好的解决了这类问题。现在EIP不仅仅能够绑定ECS、还可以绑定SLB（私网SLB）和NATGW，并且能够使用共享带宽，和共享流量包，通过增强95带宽计费、闲时流量计费等特性，更加有效的节约云上公网的成本，更多EIP详细信息请参考弹性公网IP及帮助文档。

> 注意：EIP只能绑定一台ECS，同时提供访问公网和被公网访问的能力。

### NAT网关

帮助您在VPC环境下构建一个公网流量的出入口，通过自定义SNAT，DNAT规则灵活使用网络资源，支持多IP，支持共享公网带宽。

当您的VPC中有众多ECS需要访问公网时，针对每个ECS购买公网带宽，或每个ECS都配置一个EIP，将是一件非常令人烦恼的事情，在配置和对账管理上都比较麻烦，NAT网关就是用来解决这个问题的，可以把NAT网关想象成您家中的路由器，不论是PC、手机、PAD、TV或任何需要连接Internet的设备，只要连到路由器，就可以通过路由器访问公网了，这就是NAT网关里面的SNAT功能。NAT网关还有DNAT功能，可以让VPC内的ECS实例通过NAT网关被Internet主动访问，这里不在展开，详情可以参考NAT网关产品及产品帮助文档。

> 注意：NAT网关可以同时让多台ECS具有访问公网和被公网访问的能力，单没有流量分发、负载均衡的能力。

### 组网示意图及流量路径

![4][4]

如上图所示，可以看到几种公网入口的流量路径，总体来说，满足如下原则：

流量从哪里进来，就从哪里出去！

1. 通过负载均衡进入的流量在负载均衡SLB上限速/计费，仅收取出方向流量费用，入方向流量不收取（在未来可能会改变），SLB到ECS之间是阿里云内网通信，不收取流量费用。
2. 来自弹性公网IP/NAT网关的流量，分别在弹性公网IP/NAT网关上进行限速/计费，详情参考弹性公网IP和NAT网关；如果在购买ECS时选择了公网带宽，限速/计费点在ECS上。
3. 负载均衡SLB仅提供被动访问公网的能力，即后端ECS只能在收到通过负载均衡SLB转发来的公网的请求时，才能访问公网回应该请求，如后端ECS希望主动发起公网访问，则需要配置/购买ECS公网带宽、弹性公网IP或NAT网关来实现。
4. ECS公网带宽（购买ECS时配置）、弹性公网IP、NAT网关均可以实现ECS的双向公网访问（访问或被访问），但没有流量分发和负载均衡的能力。
5. SLB和后端ECS之间是通过内网进行通信的，所以如果ECS仅仅处理来自负载均衡的请求，那么可以不需要额外购买公网带宽（ECS公网带宽/弹性公网IP/NAT网关等）。

[请看云栖社区](https://yq.aliyun.com/articles/391631) 评论中有一段解释非常有趣哈哈哈……

如果按照现实中（婚恋）的理解：

1. 早期的弹性ip（结婚）：只是用来一对男女之间互相获取婚恋关系，比如结婚。
2. 现在的弹性IP（结婚）：是除了婚恋关系（结婚），还会共享爱情（SLB）、各自的亲朋好友（NAT）、以及共享财产等。
3. SLB负载均衡（婚恋网）：就类似现在的婚恋网，只有用户有需求（美女），婚恋网就会将用户的大量需求（身高、职业、长相等）去和后端的信息匹配（美女），从而找到合适的对象。
4. NAT网关（处对象）：很多男女之间、各自都有自己的想要的婚姻，可以后很多单身男追很多单身女。都保持自己的路径。

## 阿里云专有网络 VPC 自建 NAT 网关

这部分来源 [阿里云专有网络VPC自建NAT网关](https://amos-x.com/index.php/amos/archives/centos7-aliyun-nat/)

### 前言

在阿里云中购买服务器，可以免费自建专有网络VPC，就可以将购买的服务器放在一个网段中，成为互通的内网，加快内网中服务器的访问速度。但是专有网络中不是每一台服务器都有公网IP和带宽的，在访问服务器时，我们可以通过nginx，负载均衡等来实现对内网服务器的访问。但反过来，内网服务器要访问外网，就需要有NAT网关，但是阿里云的NAT网关是需要额外花钱购买共享带宽的，也就是专有网络中的服务器可以用购买的共享带宽来上网。但是，这要钱啊！

在我们已经购买了公网IP和带宽的情况下，就可以利用现有的公网ip和带宽，在专有网络内，自建NAT网关，实现专有网络内所有服务器的上网。

注意：在阿里云的传统网络中，是不支持自建NAT网关的。只有在专有网络VPC中，才可以，但是VPC是免费创建的！免费！ 很好，都不要钱。

下面我们就记录介绍一下如何在阿里云的的VPC中，自建NAT网关，实现上网。另外，别的云服务，方法类似，可以借鉴参考。

### 正文

首先，你需要有如下条件：

- 一台带公网IP和带宽的阿里云ECS
- 一个VPC专有网络，并上面有IP和带宽的ECS放入专有网络内

好了，下面进行自建NAT的步骤。

### 1. 添加路由条目

进入专有网络VPC中，进入路由表，进入路由表管理界面，选择添加路由条目

![1][1]
![2][2]

按如下配置新添加的路由条目，选择有公网IP和带宽的ECS实例作为下一跳。

![3][3]

OK，阿里云控制台上只做这一个设置即可。

### 2. 配置服务器

下面进入你刚才作为下一跳的ECS实例，按照如下进行操作配置

```bash
# 开启firewalld防火墙，默认是关闭的。
$ systemctl enable firewalld
$ systemctl start firewalld

# 网卡默认是在public的zone内，也是默认zone。永久添加源地址转换功能
$ firewall-cmd --add-masquerade --permanent
$ firewall-cmd --reload

# 添加网卡的ip转发功能，添加如下配置到文件最后
$ vim /etc/sysctl.conf
----------------------------------------------------------------
net.ipv4.ip_forward=1
----------------------------------------------------------------
  
# 重载网络配置生效
$ sysctl -p
```

OK，到此，自建NAT网关成功，实现了内网主机通过这台机进行上网，而反向的访问，就可以使用nginx的反向代理进行实现。

## 参考

- [阿里云专有网络VPC自建NAT网关](https://amos-x.com/index.php/amos/archives/centos7-aliyun-nat/)
- [iptables学习笔记：端口转发之“外网访问内网”](https://blog.csdn.net/subfate/article/details/52659446)
- [详解SLB、EIP、NAT网关之间区别， 合理选择云上公网入口](https://yq.aliyun.com/articles/391631)

[1]: /images/linux/aliyun-nat/1.png
[2]: /images/linux/aliyun-nat/2.png
[3]: /images/linux/aliyun-nat/3.png
[4]: /images/linux/aliyun-nat/4.png
